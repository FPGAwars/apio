# -*- coding: utf-8 -*-
# -- This file is part of the Apio project
# -- (C) 2016-2024 FPGAwars
# -- Authors
# --  * Jes√∫s Arroyo (2016-2019)
# --  * Juan Gonzalez (obijuan) (2019-2024)
# -- License GPLv2
"""Implementation of 'apio api' command"""

import sys
import json
from pathlib import Path
import click
from apio.commands import options
from apio.common.apio_console import cout, cerror
from apio.common.apio_styles import INFO
from apio.utils import cmd_util
from apio.apio_context import ApioContext, ApioContextScope
from apio.utils.cmd_util import ApioGroup, ApioSubgroup, ApioCommand


# ------ apio api info

# -- Text in the rich-text format of the python rich library.
APIO_API_INFO_HELP = """
The command 'apio api info' exports apio information as a JSON document.

The optional flag '--timestamp' allows the caller to embed in the JSON \
document a known timestamp that allows to verify that the JSON document \
was indeed was generated by the same invocation.

Examples:[code]
  apio api info                # Write to stdout
  apio api info  -o apio.json  # Write to a file[/code]

Currently, the JSON document includes a list of supported boards and various
information about them. Additional information can be added as needed.
"""


timestamp_option = click.option(
    "timestamp",  # Var name.
    "-t",
    "--timestamp",
    type=str,
    metavar="text",
    help="Set a user provided timestamp.",
    cls=cmd_util.ApioOption,
)

output_option = click.option(
    "output",  # Var name.
    "-o",
    "--output",
    type=str,
    metavar="file-name",
    help="Set output file.",
    cls=cmd_util.ApioOption,
)


@click.command(
    name="info",
    cls=ApioCommand,
    short_help="Retrieve apio information.",
    help=APIO_API_INFO_HELP,
)
@timestamp_option
@output_option
@options.force_option_gen(help="Overwrite output file.")
def _info_cli(
    # Options
    timestamp: str,
    output: str,
    force: bool,
):
    """Implements the 'apio apio info' command."""

    # pylint: disable=too-many-locals

    # -- For now, the information is not in a project context. That may
    # -- change in the future.
    apio_ctx = ApioContext(scope=ApioContextScope.NO_PROJECT)

    # -- The top dict that we will emit as json.
    top_dict = {}

    # -- Append user timestamp if specified.
    if timestamp:
        top_dict["timestamp"] = timestamp

    # -- Generate the 'boards' section.
    boards_section = {}
    for board_id, board_info in apio_ctx.boards.items():
        # -- The board output dict.
        new_board = {}

        # -- Add board description
        new_board["description"] = board_info.get("description", None)

        # -- Add board's fpga information.
        new_fpga = {}
        fpga_id = board_info.get("fpga", None)
        fpga_info = apio_ctx.fpgas.get(fpga_id, {})
        new_fpga["id"] = fpga_id
        new_fpga["part-num"] = fpga_info.get("part_num", None)
        new_fpga["arch"] = fpga_info.get("arch", None)
        new_board["fpga"] = new_fpga

        # -- Add board's programmer information.
        new_programmer = {}
        programmer_id = board_info.get("programmer", {}).get("type", None)
        new_programmer["id"] = programmer_id
        new_board["programmer"] = new_programmer

        # -- Add the board to the boards dict.
        boards_section[board_id] = new_board

    # -- Add the boards section to the top dict.
    top_dict["boards"] = boards_section

    # -- Format the top dict as json text.
    text = json.dumps(top_dict, indent=2)

    if output:
        # -- Output the json text to a user specified file.
        output_path = Path(output)

        if output_path.is_dir():
            cerror(f"The output path {output_path} is a directory.")
            sys.exit(1)

        if output_path.exists() and not force:
            cerror(f"The file already exists {output_path}.")
            cout("Use the --force option to allow overwriting.", style=INFO)
            sys.exit(1)

        with open(output, "w", encoding="utf-8") as f:
            f.write(text)
    else:
        # -- Output the json text to stdout.
        print(text, file=sys.stdout)


# ------ apio apio

# -- Text in the rich-text format of the python rich library.
APIO_API_HELP = """
The command group 'apio apio' contains subcommands that that are intended \
to be used by tools and programs such as icestudio, rather than being used \
directly by users.
"""

# -- We have only a single group with the title 'Subcommands'.
SUBGROUPS = [
    ApioSubgroup(
        "Subcommands",
        [
            _info_cli,
        ],
    )
]


@click.command(
    name="api",
    cls=ApioGroup,
    subgroups=SUBGROUPS,
    short_help="Apio programmatic interface.",
    help=APIO_API_HELP,
)
def cli():
    """Implements the 'apio apio' command group."""

    # pass
